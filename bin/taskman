#!/usr/bin/env php
<?php

(function () {
    $composer = json_decode(file_get_contents('composer.json'), true);
    $composer += ['config' => []];
    $composer['config'] += ['vendor-dir' => getcwd() . '/vendor'];

    $loader = array_reduce(
        [
            $composer['config']['vendor-dir'] . '/autoload.php',
            getcwd() . '/vendor/autoload.php',
            __DIR__ . '/vendor/autoload.php',
            __DIR__ . '/../vendor/autoload.php',
            __DIR__ . '/../../autoload.php',
            __DIR__ . '/../../../autoload.php',
            __DIR__ . '/../../vendor/autoload.php'
        ],
        static function (?string $loaded, string $file): ?string {
            if (!$loaded && is_file($file)) {
                require_once($file);

                return $file;
            }

            return $loaded;
        }
    );

    if (!$loader) {
        fwrite(
            STDERR,
            'You must set up the project dependencies, run the following commands:' . PHP_EOL .
                'curl -s http://getcomposer.org/installer | php' . PHP_EOL .
                'php composer.phar install' . PHP_EOL
        );
        exit(1);
    }

    $classLoader = require $loader;

    $runner = new \PhpTaskman\Core\Runner(null, null, $classLoader);

    exit($runner->run($_SERVER['argv']));
})();
